# API Документация

Данная документация описывает REST API для управления пользователями, проектами, задачами, уведомлениями, ролями, должностями и аутентификацией. Все запросы используют JSON для обмена данными, а даты передаются в формате ISO 8601. Для аутентификации используется JWT токен, передаваемый в заголовке `Authorization: Bearer <token>`.

---

## Общие принципы

- **Аутентификация**: Большинство эндпоинтов требуют JWT токен, полученный через `/auth/login`.
- **Ошибки**: Возвращаются в формате JSON с полями `error` (строка) и, при наличии, `details` (объект или строка).
- **Логирование**: Действия, изменяющие данные, логируются в таблице `AuditLog` (кроме уведомлений и некоторых внутренних операций).
- **Уведомления**: Создаются автоматически при определенных действиях (например, создание проекта, задачи, добавление участника).

---

## Эндпоинты

### 1. Аутентификация

#### POST /auth/login
Аутентифицирует пользователя и возвращает JWT токен.

- **Доступ**: Открыт
- **Тело запроса**:
  ```json
  {
    "username": "string",
    "password": "string"
  }
  ```
- **Успешный ответ** (200):
  ```json
  {
    "access_token": "jwt_token",
    "token_type": "Bearer"
  }
  ```
- **Ошибки**:
  - 401: `{"error": "Данные введены неверно"}`

#### GET /auth/me
Возвращает информацию о текущем пользователе.

- **Доступ**: Авторизованный пользователь
- **Успешный ответ** (200):
  ```json
  {
    "id": 1,
    "username": "user1",
    "full_name": "Иван Иванов",
    "email": "ivan@example.com",
    "positions": ["Администратор"]
  }
  ```

#### PATCH /auth/me
Обновляет данные текущего пользователя.

- **Доступ**: Авторизованный пользователь
- **Тело запроса** (частично):
  ```json
  {
    "full_name": "string",
    "phone": "string",
    "email": "string"
  }
  ```
- **Успешный ответ** (200):
  ```json
  {"message": "Информация о пользователе обновлена"}
  ```
- **Ошибки**:
  - 400: `{"error": "Некорректные данные", "details": {...}}`

---

### 2. Пользователи (Администрирование)

#### GET /admin/users
Возвращает список всех пользователей.

- **Доступ**: Администратор
- **Успешный ответ** (200):
  ```json
  [
    {
      "id": 1,
      "username": "user1",
      "full_name": "Иван Иванов",
      "email": "ivan@example.com",
      "is_active": true,
      "positions": ["Администратор"]
    }
  ]
  ```
- **Ошибки**:
  - 403: `{"error": "Требуются права администратора"}`

#### POST /admin/users
Создает нового пользователя.

- **Доступ**: Администратор
- **Тело запроса**:
  ```json
  {
    "username": "string",
    "password": "string",
    "full_name": "string",
    "phone": "string",
    "email": "string",
    "is_active": true
  }
  ```
- **Успешный ответ** (201):
  ```json
  {"message": "Пользователь user1 успешно создан", "id": 1}
  ```
- **Ошибки**:
  - 400: `{"error": "Имя пользователя уже существует"}`

#### PATCH /admin/users/<user_id>
Обновляет данные пользователя.

- **Доступ**: Администратор
- **Тело запроса** (частично):
  ```json
  {
    "username": "string",
    "full_name": "string",
    "phone": "string",
    "email": "string",
    "is_active": true,
    "new_password": "string"
  }
  ```
- **Успешный ответ** (200):
  ```json
  {"message": "Пользователь user1 обновлен"}
  ```

#### GET /admin/users/<user_id>
Возвращает подробную информацию о пользователе.

- **Доступ**: Администратор
- **Успешный ответ** (200):
  ```json
  {
    "id": 1,
    "username": "user1",
    "full_name": "Иван Иванов",
    "email": "ivan@example.com",
    "phone": "+79991234567",
    "is_active": true,
    "positions": ["Администратор"],
    "created_at": "2023-01-01T12:00:00Z",
    "updated_at": "2023-01-02T12:00:00Z"
  }
  ```

#### DELETE /admin/users/<user_id>
Удаляет пользователя и связанные данные.

- **Доступ**: Администратор
- **Успешный ответ** (200):
  ```json
  {"message": "Пользователь user1 удален"}
  ```

---

### 3. Проекты

#### POST /projects/
Создает новый проект и добавляет текущего пользователя как участника.

- **Доступ**: Администратор
- **Тело запроса**:
  ```json
  {
    "title": "string",
    "description": "string",
    "deadline": "2023-12-31T23:59:59Z"
  }
  ```
- **Успешный ответ** (201):
  ```json
  {"id": 1}
  ```

#### PATCH /projects/<project_id>
Обновляет данные проекта.

- **Доступ**: Администратор
- **Тело запроса** (частично):
  ```json
  {
    "title": "string",
    "description": "string",
    "deadline": "2023-12-31T23:59:59Z",
    "is_archived": true
  }
  ```
- **Успешный ответ** (200):
  ```json
  {"message": "Проект обновлен"}
  ```

#### POST /projects/<project_id>/archive
Помечает проект как архивный.

- **Доступ**: Администратор
- **Успешный ответ** (200):
  ```json
  {"message": "Проект заархивирован"}
  ```

#### GET /projects/
Возвращает список проектов пользователя.

- **Доступ**: Авторизованный пользователь
- **Успешный ответ** (200):
  ```json
  [
    {
      "id": 1,
      "title": "Проект 1",
      "description": "Описание",
      "created_by": 1,
      "deadline": "2023-12-31T23:59:59Z",
      "is_archived": false
    }
  ]
  ```

#### GET /projects/<project_id>/members
Возвращает список участников проекта.

- **Доступ**: Участник проекта
- **Успешный ответ** (200):
  ```json
  [
    {
      "user_id": 1,
      "username": "user1",
      "full_name": "Иван Иванов"
    }
  ]
  ```

#### POST /projects/<project_id>/members
Добавляет пользователя в проект.

- **Доступ**: Администратор
- **Тело запроса**:
  ```json
  {"user_id": 2}
  ```
- **Успешный ответ** (201):
  ```json
  {"message": "Пользователь добавлен"}
  ```

#### DELETE /projects/<project_id>/members/<user_id>
Удаляет пользователя из проекта.

- **Доступ**: Администратор
- **Успешный ответ** (200):
  ```json
  {"message": "Пользователь удален"}
  ```

#### DELETE /projects/<project_id>
Удаляет проект и связанные данные.

- **Доступ**: Администратор или руководитель проекта
- **Успешный ответ** (200):
  ```json
  {"message": "Проект Проект 1 удален"}
  ```

---

### 4. Этапы проекта

#### POST /projects/<project_id>/stages
Создает новый этап в проекте.

- **Доступ**: Администратор
- **Тело запроса**:
  ```json
  {
    "title": "string",
    "status": "planned",
    "deadline": "2023-12-31T23:59:59Z",
    "sequence": 1
  }
  ```
- **Успешный ответ** (201):
  ```json
  {"id": 1}
  ```

#### PATCH /projects/<project_id>/stages/<stage_id>
Обновляет данные этапа.

- **Доступ**: Администратор
- **Тело запроса** (частично):
  ```json
  {
    "title": "string",
    "status": "in_progress",
    "deadline": "2023-12-31T23:59:59Z",
    "sequence": 2
  }
  ```
- **Успешный ответ** (200):
  ```json
  {"message": "Этап обновлен"}
  ```

#### GET /projects/<project_id>/stages
Возвращает список этапов проекта.

- **Доступ**: Участник проекта
- **Успешный ответ** (200):
  ```json
  [
    {
      "id": 1,
      "title": "Этап 1",
      "status": "planned",
      "deadline": "2023-12-31T23:59:59Z",
      "sequence": 1
    }
  ]
  ```

#### DELETE /projects/<project_id>/stages/<stage_id>
Удаляет этап и связанные задачи.

- **Доступ**: Администратор или руководитель проекта
- **Успешный ответ** (200):
  ```json
  {"message": "Этап Этап 1 удален"}
  ```

---

### 5. Задачи

#### POST /tasks/
Создает новую задачу в указанном этапе.

- **Доступ**: Участник проекта
- **Тело запроса**:
  ```json
  {
    "stage_id": 1,
    "title": "string",
    "description": "string",
    "priority": "medium",
    "is_completed": false,
    "deadline": "2023-12-31T23:59:59Z"
  }
  ```
- **Успешный ответ** (201):
  ```json
  {"id": 1}
  ```

#### GET /tasks/
Возвращает список задач по `stage_id` или `project_id`.

- **Доступ**: Участник проекта
- **Параметры запроса**:
  - `stage_id` (int, опционально)
  - `project_id` (int, опционально)
- **Успешный ответ** (200):
  ```json
  [
    {
      "id": 1,
      "title": "Задача 1",
      "stage_id": 1,
      "priority": "medium",
      "is_completed": false,
      "deadline": "2023-12-31T23:59:59Z",
      "depends_on_tasks": []
    }
  ]
  ```

#### PUT /tasks/<task_id>/raci
Обновляет RACI матрицу задачи.

- **Доступ**: Руководитель проекта или администратор
- **Тело запроса**:
  ```json
  {
    "assignments": [
      {"user_id": 1, "role_id": 1},
      {"user_id": 2, "role_id": 2}
    ]
  }
  ```
- **Успешный ответ** (200):
  ```json
  {"message": "RACI матрица обновлена"}
  ```

#### GET /tasks/<task_id>/raci
Возвращает RACI матрицу задачи.

- **Доступ**: Участник проекта
- **Успешный ответ** (200):
  ```json
  [
    {
      "user_id": 1,
      "username": "user1",
      "role": "R"
    }
  ]
  ```

#### GET /tasks/raci_matrix
Возвращает RACI матрицу для всех задач в проекте или этапе.

- **Доступ**: Участник проекта
- **Параметры запроса**:
  - `stage_id` (int, опционально)
  - `project_id` (int, опционально)
- **Успешный ответ** (200):
  ```json
  {
    "tasks": [{"task_id": 1, "title": "Задача 1"}],
    "users": [{"user_id": 1, "username": "user1"}],
    "matrix": [["R"]]
  }
  ```

#### PATCH /tasks/<task_id>/status
Обновляет статус завершения задачи.

- **Доступ**: Исполнитель, ответственный или администратор
- **Тело запроса**:
  ```json
  {"is_completed": true}
  ```
- **Успешный ответ** (200):
  ```json
  {"message": "Статус задачи обновлен"}
  ```

#### GET /tasks/<task_id>/dependencies
Возвращает список зависимостей задачи.

- **Доступ**: Участник проекта
- **Успешный ответ** (200):
  ```json
  [
    {"id": 2, "title": "Задача 2"}
  ]
  ```

#### PUT /tasks/<task_id>/dependencies
Обновляет список зависимостей задачи.

- **Доступ**: Ответственный или администратор
- **Тело запроса**:
  ```json
  {"dependencies": [2, 3]}
  ```
- **Успешный ответ** (200):
  ```json
  {"message": "Зависимости задачи обновлены"}
  ```

#### DELETE /tasks/<task_id>
Удаляет задачу.

- **Доступ**: Ответственный или администратор
- **Успешный ответ** (200):
  ```json
  {"message": "Задача Задача 1 удалена"}
  ```

---

### 6. Уведомления

#### GET /notifications/notifications
Возвращает список уведомлений пользователя.

- **Доступ**: Авторизованный пользователь
- **Успешный ответ** (200):
  ```json
  [
    {
      "id": 1,
      "message": "Создан проект: Проект 1",
      "is_read": false,
      "related_entity": "project",
      "related_entity_id": 1,
      "created_at": "2023-01-01T12:00:00Z"
    }
  ]
  ```

---

### 7. Роли

#### GET /projects/roles
Возвращает список всех ролей.

- **Доступ**: Авторизованный пользователь
- **Успешный ответ** (200):
  ```json
  [
    {
      "id": 1,
      "title": "R",
      "is_custom": false
    }
  ]
  ```

#### POST /admin/roles
Создает новую роль.

- **Доступ**: Администратор
- **Тело запроса**:
  ```json
  {"title": "string"}
  ```
- **Успешный ответ** (201):
  ```json
  {"message": "Роль string успешно создана", "id": 1}
  ```

#### DELETE /admin/roles/<role_id>
Удаляет роль.

- **Доступ**: Администратор
- **Успешный ответ** (200):
  ```json
  {"message": "Роль string удалена"}
  ```

---

### 8. Должности

#### POST /admin/positions
Создает новую должность.

- **Доступ**: Администратор
- **Тело запроса**:
  ```json
  {"title": "string"}
  ```
- **Успешный ответ** (201):
  ```json
  {"message": "Должность string успешно создана", "id": 1}
  ```

#### GET /admin/positions
Возвращает список всех должностей.

- **Доступ**: Администратор
- **Успешный ответ** (200):
  ```json
  [
    {
      "id": 1,
      "title": "Администратор",
      "created_at": "2023-01-01T12:00:00Z"
    }
  ]
  ```

#### POST /admin/users/<user_id>/positions
Назначает должность пользователю.

- **Доступ**: Администратор
- **Тело запроса**:
  ```json
  {"position_id": 1}
  ```
- **Успешный ответ** (201):
  ```json
  {"message": "Должность Администратор добавлена пользователю user1"}
  ```

#### DELETE /admin/users/<user_id>/positions/<position_id>
Удаляет должность у пользователя.

- **Доступ**: Администратор
- **Успешный ответ** (200):
  ```json
  {"message": "Должность Администратор удалена у пользователя user1"}
  ```

#### DELETE /admin/positions/<position_id>
Удаляет должность.

- **Доступ**: Администратор
- **Успешный ответ** (200):
  ```json
  {"message": "Должность string удалена"}
  ```

---

### 9. Дашборд

#### GET /projects/dashboard
Возвращает сводную информацию о проектах пользователя.

- **Доступ**: Авторизованный пользователь
- **Успешный ответ** (200):
  ```json
  {
    "projects": [
      {
        "id": 1,
        "title": "Проект 1",
        "total_tasks": 5,
        "completed_tasks": 3,
        "progress": 60.0,
        "is_archived": false
      }
    ],
    "unread_notifications": 2,
    "total_incomplete_tasks": 2
  }
  ```

---

## Ошибки

- **400**: Некорректные данные в запросе.
- **403**: Недостаточно прав доступа.
- **404**: Сущность не найдена.
- **500**: Внутренняя ошибка сервера.