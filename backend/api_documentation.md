# Документация API системы управления проектами

## Общая информация
API предоставляет функциональность для управления проектами, задачами, участниками, RACI-матрицей и уведомлениями. Все запросы требуют аутентификации через JWT-токен, передаваемый в заголовке `Authorization: Bearer <token>`.

- **Базовый URL**: `/api`
- **Формат ответов**: JSON
- **Кодировка**: UTF-8
- **Ошибки**: Возвращаются в формате `{ "error": "Сообщение об ошибке", "details": {...} }` с соответствующим HTTP-кодом.

## Обработка ошибок
Все ошибки возвращаются в формате JSON с полями:
- `error`: Краткое описание ошибки (на русском).
- `details`: Дополнительные детали ошибки (если применимо).

### Общие ошибки
- **401 Unauthorized**: 
  - `{ "error": "Данные введены неверно" }` – неверные учетные данные при авторизации.
  - `{ "error": "Требуется авторизация" }` – отсутствует или недействителен JWT-токен.
- **403 Forbidden**:
  - `{ "error": "Требуются права администратора" }` – действие доступно только администратору.
  - `{ "error": "Access denied" }` – пользователь не имеет доступа к ресурсу.
  - `{ "error": "Only accountable or admin can update RACI" }` – только ответственный (роль A) или администратор может обновлять RACI.
  - `{ "error": "Only accountable or admin can update task status" }` – только ответственный или администратор может обновлять статус задачи.
  - `{ "error": "Only accountable or admin can update dependencies" }` – только ответственный или администратор может обновлять зависимости.
- **400 Bad Request**:
  - `{ "error": "Некорректные данные", "details": {...} }` – ошибка валидации входных данных.
  - `{ "error": "Имя пользователя уже существует" }` – при создании пользователя с занятым именем.
  - `{ "error": "Проект с таким названием уже существует" }` – при создании проекта с занятым названием.
  - `{ "error": "Пользователь уже в проекте" }` – при попытке добавить уже существующего участника.
  - `{ "error": "Задача с названием \"{title}\" не найдена в этапе" }` – при попытке добавить несуществующую задачу в зависимости.
  - `{ "error": "Задача не может зависеть от самой себя" }` – при попытке создать зависимость задачи от самой себя.
  - `{ "error": "Добавление зависимости \"{title}\" создаёт циклическую зависимость" }` – при попытке создать циклическую зависимость.
  - `{ "error": "Задача \"{title}\" не может быть завершена, так как зависимая задача \"{dep_title}\" не завершена" }` – при попытке завершить задачу с незавершенными зависимостями.
- **404 Not Found**:
  - `{ "error": "Ресурс не найден" }` – указанный ресурс (проект, задача, пользователь и т.д.) не существует.
- **500 Internal Server Error**:
  - `{ "error": "Внутренняя ошибка сервера", "details": "..." }` – непредвиденная ошибка на сервере.

## Аутентификация
### POST /auth/login
**Описание**: Аутентификация пользователя. Возвращает JWT-токен для последующих запросов.

**Тело запроса**:
```json
{
  "username": "string",
  "password": "string"
}
```

**Успешный ответ (200)**:
```json
{
  "access_token": "string",
  "token_type": "Bearer"
}
```

**Ошибки**:
- 401: `{ "error": "Данные введены неверно" }`

### GET /auth/me
**Описание**: Получение данных текущего пользователя.

**Заголовок**: `Authorization: Bearer <token>`

**Успешный ответ (200)**:
```json
{
  "id": integer,
  "username": "string",
  "full_name": "string",
  "email": "string",
  "positions": ["string"]
}
```

**Ошибки**:
- 401: `{ "error": "Требуется авторизация" }`

### PATCH /auth/me
**Описание**: Обновление данных текущего пользователя (имя, телефон, email).

**Заголовок**: `Authorization: Bearer <token>`

**Тело запроса** (partial):
```json
{
  "full_name": "string",
  "phone": "string",
  "email": "string"
}
```

**Успешный ответ (200)**:
```json
{
  "message": "Информация о пользователе обновлена"
}
```

**Ошибки**:
- 400: `{ "error": "Некорректные данные", "details": {...} }`
- 500: `{ "error": "Внутренняя ошибка сервера", "details": "..." }`

## Уведомления
### GET /notifications
**Описание**: Получение списка уведомлений текущего пользователя.

**Заголовок**: `Authorization: Bearer <token>`

**Успешный ответ (200)**:
```json
[
  {
    "id": integer,
    "message": "string",
    "is_read": boolean,
    "related_entity": "project | stage | task",
    "related_entity_id": integer,
    "created_at": "string (ISO 8601)"
  }
]
```

**Ошибки**:
- 401: `{ "error": "Требуется авторизация" }`

## Проекты
### GET /projects
**Описание**: Получение списка проектов, в которых участвует текущий пользователь.

**Заголовок**: `Authorization: Bearer <token>`

**Успешный ответ (200)**:
```json
[
  {
    "id": integer,
    "title": "string",
    "description": "string",
    "created_by": integer,
    "deadline": "string (ISO 8601) | null",
    "is_archived": boolean
  }
]
```

**Ошибки**:
- 401: `{ "error": "Требуется авторизация" }`

### POST /projects
**Описание**: Создание нового проекта (только для администраторов).

**Заголовок**: `Authorization: Bearer <token>`

**Тело запроса**:
```json
{
  "title": "string",
  "description": "string | null",
  "deadline": "string (ISO 8601) | null"
}
```

**Успешный ответ (201)**:
```json
{
  "id": integer
}
```

**Ошибки**:
- 403: `{ "error": "Требуются права администратора" }`
- 400: `{ "error": "Некорректные данные", "details": {...} }`
- 400: `{ "error": "Проект с таким названием уже существует" }`
- 500: `{ "error": "Внутренняя ошибка сервера", "details": "..." }`

### PATCH /projects/<project_id>
**Описание**: Обновление данных проекта (только для администраторов).

**Заголовок**: `Authorization: Bearer <token>`

**Тело запроса** (partial):
```json
{
  "title": "string",
  "description": "string | null",
  "deadline": "string (ISO 8601) | null",
  "is_archived": boolean
}
```

**Успешный ответ (200)**:
```json
{
  "message": "Проект обновлен"
}
```

**Ошибки**:
- 403: `{ "error": "Требуются права администратора" }`
- 400: `{ "error": "Некорректные данные", "details": {...} }`
- 400: `{ "error": "Проект с таким названием уже существует" }`
- 404: `{ "error": "Ресурс не найден" }`
- 500: `{ "error": "Внутренняя ошибка сервера", "details": "..." }`

### POST /projects/<project_id>/archive
**Описание**: Архивирование проекта (только для администраторов).

**Заголовок**: `Authorization: Bearer <token>`

**Успешный ответ (200)**:
```json
{
  "message": "Проект заархивирован"
}
```

**Ошибки**:
- 403: `{ "error": "Требуются права администратора" }`
- 404: `{ "error": "Ресурса не найден" }`

### POST /projects/<project_id>/members
**Описание**: Добавление пользователя в проект (только для администраторов).

**Заголовок**: `Authorization: Bearer <token>`

**Тело запроса**:
```json
{
  "user_id": integer
}
```

**Успешный ответ (201)**:
```json
{
  "message": "Пользователь добавлен"
}
```

**Ошибки**:
- 403: `{ "error": "Требуются ersten права администратора" }`
- 400: `{ "error": "Некорректные данные", "details": {...} }`
- 400: `{ "error": "Пользователь уже в проекте" }`
- 404: `{ "error": "Ресурс не найден" }`
- 500: `{ "error": "Внутренняя ошибка сервера", "details": "..." }`

### DELETE /projects/<project_id>/members/<user_id>
**Описание**: Удаление пользователя из проекта (только для администраторов).

**Заголовок**: `Authorization: Bearer <token>`

**Успешный ответ (200)**:
```json
{
  "message": "Пользователь удален"
}
```

**Ошибки**:
- 403: `{ "error": "Требуются права администратора" }`
- 404: `{ "error": "Ресурс не найден" }`

### GET /projects/<project_id>/members
**Описание**: Получение списка участников проекта (доступно участникам проекта).

**Заголовок**: `Authorization: Bearer <token>`

**Успешный ответ (200)**:
```json
[
  {
    "user_id": integer,
    "username": "string",
    "full_name": "string"
  }
]
```

**Ошибки**:
- 403: `{ "error": "Access denied" }`
- 404: `{ "error": "Ресурс не найден" }`

### POST /projects/<project_id>/stages
**Описание**: Создание нового этапа в проекте (только для администраторов).

**Заголовок**: `Authorization: Bearer <token>`

**Тело запроса**:
```json
{
  "title": "string",
  "status": "planned | in_progress | completed",
  "deadline": "string (ISO 8601) | null",
  "sequence": integer
}
```

**Успешный ответ (201)**:
```json
{
  "id": integer
}
```

**Ошибки**:
- 403: `{ "error": "Требуются права администратора" }`
- 400: `{ "error": "Некорректные данные", "details": {...} }`
- 404: `{ "error": "Ресурс не найден" }`

### PATCH /projects/<project_id>/stages/<stage_id>
**Описание**: Обновление данных этапа проекта (только для администраторов).

**Заголовок**: `Authorization: Bearer <token>`

**Тело запроса** (partial):
```json
{
  "title": "string",
  "status": "planned | in_progress | completed",
  "deadline": "string (ISO 8601) | null",
  "sequence": integer
}
```

**Успешный ответ (200)**:
```json
{
  "message": "Этап обновлен"
}
```

**Ошибки**:
- 403: `{ "error": "Требуются права администратора" }`
- 404: `{ "error": "Ресурс не найден" }`
- 400: `{ "error": "Некорректные данные", "details": {...} }`

### GET /projects/<project_id>/stages
**Описание**: Получение списка этапов проекта (доступно участникам проекта).

**Заголовок**: `Authorization: Bearer <token>`

**Успешный ответ (200)**:
```json
[
  {
    "id": integer,
    "title": "string",
    "status": "planned | in_progress | completed",
    "deadline": "string (ISO 8601) | null",
    "sequence": integer
  }
]
```

**Ошибки**:
- 403: `{ "error": "Access denied" }`
- 404: `{ "error": "Ресурс не найден" }`

### GET /projects/dashboard
**Описание**: Получение данных для дашборда (доступно любому авторизованному пользователю).

**Заголовок**: `Authorization: Bearer <token>`

**Успешный ответ (200)**:
```json
{
  "projects": [
    {
      "id": integer,
      "title": "string",
      "total_tasks": integer,
      "completed_tasks": integer,
      "progress": float,
      "is_archived": boolean
    }
  ],
  "unread_notifications": integer,
  "total_incomplete_tasks": integer
}
```

**Ошибки**:
- 401: `{ "error": "Требуется авторизация" }`

### GET /projects/roles
**Описание**: Получение списка всех ролей (доступно любому авторизованному пользователю).

**Заголовок**: `Authorization: Bearer <token>`

**Успешный ответ (200)**:
```json
[
  {
    "id": integer,
    "title": "string",
    "is_custom": boolean
  }
]
```

**Ошибки**:
- 401: `{ "error": "Требуется авторизация" }`

## Задачи
### POST /tasks
**Описание**: Создание новой задачи в этапе проекта (доступно участникам проекта).

**Заголовок**: `Authorization: Bearer <token>`

**Тело запроса**:
```json
{
  "stage_id": integer,
  "title": "string",
  "description": "string | null",
  "priority": "low | medium | high | null",
  "is_completed": boolean,
  "deadline": "string (ISO 8601) | null"
}
```

**Успешный ответ (201)**:
```json
{
  "id": integer
}
```

**Ошибки**:
- 403: `{ "error": "Access denied" }`
- 400: `{ "error": "Некорректные данные", "details": {...} }`
- 404: `{ "error": "Ресурс не найден" }`
- 500: `{ "error": "Внутренняя ошибка сервера", "details": "..." }`

### GET /tasks
**Описание**: Получение списка задач (доступно участникам проекта).

**Заголовок**: `Authorization: Bearer <token>`

**Параметры запроса**:
- `stage_id` (optional): integer
- `project_id` (optional): integer

**Успешный ответ (200)**:
```json
[
  {
    "id": integer,
    "title": "string",
    "stage_id": integer,
    "priority": "low | medium | high",
    "is_completed": boolean,
    "deadline": "string (ISO 8601) | null"
  }
]
```

**Ошибки**:
- 403: `{ "error": "Access denied" }`
- 404: `{ "error": "Ресурс не найден" }`

### GET /tasks/<task_id>/raci
**Описание**: Получение RACI-матрицы для задачи (доступно участникам проекта).

**Заголовок**: `Authorization: Bearer <token>`

**Успешный ответ (200)**:
```json
[
  {
    "user_id": integer,
    "username": "string",
    "role": "string"
  }
]
```

**Ошибки**:
- 403: `{ "error": "Access denied" }`
- 404: `{ "error": "Ресурс не найден" }`

### PUT /tasks/<task_id>/raci
**Описание**: Обновление RACI-матрицы для задачи (доступно ответственному по RACI или администратору).

**Заголовок**: `Authorization: Bearer <token>`

**Тело запроса**:
```json
{
  "assignments": [
    {
      "user_id": integer,
      "role_id": integer
    }
  ]
}
```

**Успешный ответ (200)**:
```json
{
  "message": "RACI матрица обновлена"
}
```

**Ошибки**:
- 403: `{ "error": "Access denied" }`
- 403: `{ "error": "Only accountable or admin can update RACI" }`
- 404: `{ "error": "Ресурс не найден" }`
- 400: `{ "error": "Некорректные данные", "details": {...} }`

### PATCH /tasks/<task_id>/status
**Описание**: Обновление статуса задачи (доступно ответственному за этап или администратору).

**Заголовок**: `Authorization: Bearer <token>`

**Тело запроса**:
```json
{
  "is_completed": boolean
}
```

**Успешный ответ (200)**:
```json
{
  "message": "Статус задачи обновлен"
}
```

**Ошибки**:
- 403: `{ "error": "Access denied" }`
- 403: `{ "error": "Only accountable or admin can update task status" }`
- 400: `{ "error": "Задача \"{title}\" не может быть завершена, так как зависимая задача \"{dep_title}\" не завершена" }`
- 404: `{ "error": "Ресурс не найден" }`

### GET /tasks/<task_id>/dependencies
**Описание**: Получение списка зависимостей задачи (доступно участникам проекта).

**Заголовок**: `Authorization: Bearer <token>`

**Успешный ответ (200)**:
```json
[
  {
    "id": integer,
    "title": "string"
  }
]
```

**Ошибки**:
- 403: `{ "error": "Access denied" }`
- 404: `{ "error": "Ресурс не найден" }`

### PUT /tasks/<task_id>/dependencies
**Описание**: Обновление зависимостей задачи (доступно ответственному за этап или администратору).

**Заголовок**: `Authorization: Bearer <token>`

**Тело запроса**:
```json
{
  "dependencies": ["string"]
}
```

**Успешный ответ (200)**:
```json
{
  "message": "Зависимости задачи обновлены"
}
```

**Ошибки**:
- 403: `{ "error": "Access denied" }`
- 403: `{ "error": "Only accountable or admin can update dependencies" }`
- 400: `{ "error": "Некорректные данные", "details": {...} }`
- 400: `{ "error": "Задача с названием \"{title}\" не найдена в этапе" }`
- 400: `{ "error": "Задача не может зависеть от самой себя" }`
- 400: `{ "error": "Добавление зависимости \"{title}\" создаёт циклическую зависимость" }`
- 404: `{ "error": "Ресурс не найден" }`
- 500: `{ "error": "Внутренняя ошибка сервера", "details": "..." }`

## Администрирование
### GET /admin/users
**Описание**: Получение списка всех пользователей (только для администраторов).

**Заголовок**: `Authorization: Bearer <token>`

**Успешный ответ (200)**:
```json
[
  {
    "id": integer,
    "username": "string",
    "full_name": "string",
    "email": "string",
    "is_active": boolean,
    "positions": ["string"]
  }
]
```

**Ошибки**:
- 403: `{ "error": "Требуются права администратора" }`

### POST /admin/users
**Описание**: Создание нового пользователя (только для администраторов).

**Заголовок**: `Authorization: Bearer <token>`

**Тело запроса**:
```json
{
  "username": "string",
  "password": "string",
  "full_name": "string",
  "phone": "string | null",
  "email": "string | null",
  "is_active": boolean
}
```

**Успешный ответ (201)**:
```json
{
  "message": "Пользователь {username} успешно создан",
  "id": integer
}
```

**Ошибки**:
- 403: `{ "error": "Требуются права администратора" }`
- 400: `{ "error": "Некорректные данные", "details": {...} }`
- 400: `{ "error": "Имя пользователя уже существует" }`
- 400: `{ "error": "Имя пользователя или email уже существуют" }`
- 500: `{ "error": "Внутренняя ошибка сервера", "details": "..." }`

### PATCH /admin/users/<user_id>
**Описание**: Обновление данных пользователя (только для администраторов).

**Заголовок**: `Authorization: Bearer <token>`

**Тело запроса** (partial):
```json
{
  "username": "string",
  "full_name": "string",
  "phone": "string | null",
  "email": "string | null",
  "is_active": boolean,
  "new_password": "string | null"
}
```

**Успешный ответ (200)**:
```json
{
  "message": "Пользователь {username} обновлен"
}
```

**Ошибки**:
- 403: `{ "error": "Требуются права администратора" }`
- 400: `{ "error": "Некорректные данные", "details": {...} }`
- 400: `{ "error": "Имя пользователя уже существует" }`
- 404: `{ "error": "Ресурс не найден" }`
- 500: `{ "error": "Внутренняя ошибка сервера", "details": "..." }`

## Примечания для фронтенда и мобильного приложения
1. **Аутентификация**: Все запросы, кроме `/auth/login`, требуют заголовок `Authorization: Bearer <token>`. Токен сохраняется после успешной авторизации и должен храниться на клиенте.
2. **Формат дат**: Все даты в формате ISO 8601 (например, `2025-07-11T12:25:00.000Z`).
3. **Обработка ошибок**: Фронтенд и мобильное приложение должны отображать сообщения об ошибках из поля `error` и, при необходимости, детали из поля `details`.
4. **CORS**: На время тестирования разрешены все источники (`*`). В продакшене CORS будет ограничен (см. `app.py`).
5. **Уведомления**: Регулярно запрашивайте `/notifications` для отображения новых уведомлений. Учтите поле `is_read` для выделения непрочитанных.
6. **Дашборд**: Используйте `/projects/dashboard` для отображения общей статистики по проектам и задачам.
7. **RACI-матрица**: Для задач и этапов проверяйте доступ через роли (особенно `A` – ответственный) перед выполнением операций обновления.
8. **Зависимости задач**: При обновлении зависимостей (`/tasks/<task_id>/dependencies`) передавайте список названий задач, а не их ID.