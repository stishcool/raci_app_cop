# API Документация

## Общее описание

API предоставляет функциональность для управления проектами, задачами, ролями, уведомлениями и пользователями в системе управления проектами. Все запросы защищены с помощью JWT-аутентификации, за исключением эндпоинта авторизации. Основные сущности: пользователи, проекты, этапы, задачи, RACI-матрица, уведомления и логи аудита.

---

## Аутентификация

### POST /auth/login

Авторизация пользователя.

**Параметры запроса:**

- `username` (обязательный, string): Имя пользователя
- `password` (обязательный, string): Пароль

**Пример запроса:**

{
  "username": "admin",
  "password": "12345678"
}

**Успешный ответ (200):**

{
  "access_token": "jwt_token",
  "token_type": "Bearer"
}

**Ошибки:**

- 401: Неверные учетные данные

---

### GET /auth/me

Получение информации о текущем пользователе.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Успешный ответ (200):**

{
  "id": 1,
  "username": "admin",
  "full_name": "Системный администратор",
  "email": "<admin@example.com>",
  "positions": ["Администратор"]
}

**Ошибки:**

- 401: Токен недействителен

---

### POST /auth/add-user

Создание нового пользователя (только для администраторов).

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Параметры запроса:**

- `username` (обязательный, string): Имя пользователя (мин. 3 символа)
- `password` (обязательный, string): Пароль (мин. 8 символов)
- `full_name` (необязательный, string): Полное имя
- `phone` (необязательный, string): Телефон
- `is_active` (необязательный, boolean): Статус активности

**Пример запроса:**

{
  "username": "newuser",
  "password": "newpassword123",
  "full_name": "Новый Пользователь",
  "phone": "+1234567890",
  "is_active": true
}

**Успешный ответ (201):**

{
  "message": "Пользователь newuser успешно создан"
}

**Ошибки:**

- 400: Неверные данные или имя пользователя уже существует
- 403: Требуются права администратора
- 500: Внутренняя ошибка сервера

---

### POST /auth/change-password

Смена пароля текущего пользователя.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Параметры запроса:**

- `old_password` (обязательный, string): Текущий пароль
- `new_password` (обязательный, string): Новый пароль

**Пример запроса:**

{
  "old_password": "oldpassword123",
  "new_password": "newpassword123"
}

**Успешный ответ (200):**

{
  "message": "Пароль успешно изменен"
}

**Ошибки:**

- 400: Неверный текущий пароль
- 401: Токен недействителен

---

## Управление пользователями (Администратор)

### GET /admin/users

Получение списка всех пользователей.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Успешный ответ (200):**

[
  {
    "id": 1,
    "username": "admin",
    "full_name": "Системный администратор",
    "is_admin": true,
    "is_active": true
  }
]

**Ошибки:**

- 403: Требуются права администратора

---

### POST /admin/users

Создание нового пользователя.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Параметры запроса:**

- `username` (обязательный, string): Имя пользователя (мин. 3 символа)
- `password` (обязательный, string): Пароль (мин. 8 символов)
- `full_name` (обязательный, string): Полное имя
- `phone` (необязательный, string): Телефон
- `is_admin` (необязательный, boolean): Флаг администратора

**Пример запроса:**

{
  "username": "newuser",
  "password": "newpassword123",
  "full_name": "Новый Пользователь",
  "phone": "+1234567890",
  "is_admin": false
}

**Успешный ответ (201):**

{
  "id": 2
}

**Ошибки:**

- 400: Неверные данные или имя пользователя уже существует
- 403: Требуются права администратора
- 500: Внутренняя ошибка сервера

---

### PATCH /admin/users/<user_id>/role

Обновление роли пользователя (администратор/не администратор).

**Заголовки:**

- `Authorization: Bearer <jw_token>`

**Параметры запроса:**

- `is_admin` (обязательный, boolean): Флаг администратора

**Пример запроса:**

{
  "is_admin": true
}

**Успешный ответ (200):**

{
  "message": "Роль пользователя обновлена"
}

**Ошибки:**

- 400: Отсутствует поле is_admin
- 403: Требуются права администратора
- 404: Пользователь не найден
- 500: Внутренняя ошибка сервера

---

## Управление проектами

### GET /projects/

Получение списка проектов пользователя.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Успешный ответ (200):**

[
  {
    "id": 1,
    "title": "Проект 1",
    "description": "Описание проекта",
    "created_by": 1,
    "deadline": "2025-12-31T23:59:59",
    "is_archived": false
  }
]

**Ошибки:**

- 401: Токен недействителен

---

### POST /projects/

Создание нового проекта.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Параметры запроса:**

- `title` (обязательный, string): Название проекта
- `description` (необязательный, string): Описание
- `deadline` (необязательный, datetime): Крайний срок

**Пример запроса:**

{
  "title": "Новый проект",
  "description": "Описание нового проекта",
  "deadline": "2025-12-31T23:59:59"
}

**Успешный ответ (201):**

{
  "id": 1
}

**Ошибки:**

- 400: Неверные данные
- 401: Токен недействителен
- 500: Внутрняя ошибка сервера

---

### PATCH /projects/<project_id>

Обновление проекта.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Параметры запроса:**

- `title` (необязательный, string): Название проекта
- `description` (необязательный, string): Описание
- `deadline` (необязательный, datetime): Крайний срок
- `is_archived` (необязательный, boolean): Статус архивации

**Пример запроса:**

{
  "title": "Обновленный проект",
  "description": "Новое описание"
}

**Успешный ответ (200):**

{
  "message": "Проект обновлен"
}

**Ошибки:**

- 400: Неверные данные
- 403: Требуются права создателя или администратора
- 404: Проект не найден
- 500: Внутренняя ошибка сервера

---

### POST /projects/<project_id>/archive

Архивирование проекта.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Успешный ответ (200):**

{
  "message": "Проект заархивирован"
}

**Ошибки:**

- 404: Проект не найден

---

### GET /projects/<project_id>/members

Получение списка участников проекта.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Успешный ответ (200):**

[
  {
    "user_id": 1,
    "username": "admin",
    "full_name": "Системный администратор"
  }
]

**Ошибки:**

- 404: Проект не найден

---

### POST /projects/<project_id>/members

Добавление участника в проект.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Параметры запроса:**

- `user_id` (обязательный, integer): ID пользователя

**Пример запроса:**

{
  "user_id": 2
}

**Успешный ответ (201):**

{
  "message": "Пользователь добавлен"
}

**Ошибки:**

- 400: Неверные данные или пользователь уже в проекте
- 403: Требуются права создателя или администратора
- 404: Проект или пользователь не найден
- 500: Внутренняя ошибка сервера

---

### DELETE /projects/<project_id>/members/<user_id>

Удаление участника из проекта.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Успешный ответ (200):**

{
  "message": "Пользователь удален"
}

**Ошибки:**

- 404: Проект или пользователь не найден

---

### POST /projects/<project_id>/stages

Создание этапа проекта.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Параметры запроса:**

- `title` (обязательный, string): Название этапа
- `status` (необязательный, string): Статус этапа (planned, in_progress, completed)
- `deadline` (необязательный, datetime): Крайний срок
- `sequence` (необязательный, integer): Порядок этапа

**Пример запроса:**

{
  "title": "Этап 1",
  "status": "planned",
  "deadline": "2025-12-31T23:59:59",
  "sequence": 1
}

**Успешный ответ (201):**

{
  "id": 1
}

**Ошибки:**

- 400: Неверные данные
- 404: Проект не найден

---

### GET /projects/<project_id>/stages

Получение списка этапов проекта.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Успешный ответ (200):**

[
  {
    "id": 1,
    "title": "Этап 1",
    "status": "planned",
    "deadline": "2025-12-31T23:59:59",
    "sequence": 1
  }
]

**Ошибки:**

- 404: Проект не найден

---

### PATCH /projects/<project_id>/stages/<stage_id>

Обновление этапа проекта.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Параметры запроса:**

- `title` (необязательный, string): Название этапа
- `status` (необязательный, string): Статус этапа
- `deadline` (необязательный, datetime): Крайний срок
- `sequence` (необязательный, integer): Порядок этапа

**Пример запроса:**

{
  "title": "Обновленный этап",
  "status": "in_progress"
}

**Успешный ответ (200):**

{
  "message": "Этап обновлен"
}

**Ошибки:**

- 400: Неверные данные
- 404: Этап или проект не найден

---

### GET /projects/dashboard

Получение данных для дашборда пользователя.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Успешный ответ (200):**

{
  "projects": [
    {
      "id": 1,
      "title": "Проект 1",
      "total_tasks": 10,
      "completed_tasks": 5,
      "progress": 50.0,
      "is_archived": false
    }
  ],
  "unread_notifications": 2,
  "total_incomplete_tasks": 5
}

**Ошибки:**

- 401: Токен недействителен

---

### GET /projects/roles

Получение списка ролей (включая RACI).

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Успешный ответ (200):**

[
  {
    "id": 1,
    "title": "R",
    "is_custom": false
  }
]

**Ошибки:**

- 401: Токен недействителен

---

## Управление задачами

### POST /tasks/

Создание задачи.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Параметры запроса:**

- `stage_id` (обязательный, integer): ID этапа
- `title` (обязательный, string): Название задачи
- `description` (необязательный, string): Описание
- `priority` (необязательный, string): Приоритет (low, medium, high)
- `is_completed` (необязательный, boolean): Статус выполнения

**Пример запроса:**

{
  "stage_id": 1,
  "title": "Новая задача",
  "description": "Описание задачи",
  "priority": "high",
  "is_completed": false
}

**Успешный ответ (201):**

{
  "id": 1
}

**Ошибки:**

- 400: Неверные данные
- 403: Пользователь не является участником проекта
- 404: Этап не найден

---

### GET /tasks/

Получение списка задач.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Параметры запроса (query):**

- `stage_id` (необязательный, integer): ID этапа
- `project_id` (необязательный, integer): ID проекта

**Успешный ответ (200):**

[
  {
    "id": 1,
    "title": "Задача 1",
    "stage_id": 1,
    "priority": "medium",
    "is_completed": false
  }
]

**Ошибки:**

- 403: Пользователь не является участником проекта
- 404: Проект или этап не найден

---

### GET /tasks/<task_id>/raci

Получение RACI-матрицы для задачи.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Успешный ответ (200):**

[
  {
    "user_id": 1,
    "username": "admin",
    "role": "R"
  }
]

**Ошибки:**

- 403: Пользователь не является участником проекта
- 404: Задача не найдена

---

### PATCH /tasks/<task_id>/status

Обновление статуса задачи.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Параметры запроса:**

- `is_completed` (обязательный, boolean): Статус выполнения

**Пример запроса:**

{
  "is_completed": true
}

**Успешный ответ (200):**

{
  "message": "Статус задачи обновлен"
}

**Ошибки:**

- 403: Пользователь не является участником проекта
- 404: Задача не найдена

---

### PUT /tasks/<task_id>/raci

Обновление RACI-матрицы для задачи (только для ответственного - роль A).

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Параметры запроса:**

- `assignments` (обязательный, array): Список назначений
  - `user_id` (обязательный, integer): ID пользователя
  - `role_id` (обязательный, integer): ID роли

**Пример запроса:**

{
  "assignments": [
    {
      "user_id": 1,
      "role_id": 1
    }
  ]
}

**Успешный ответ (200):**

{
  "message": "RACI матрица обновлена"
}

**Ошибки:**

- 403: Только ответственный может обновлять RACI
- 404: Задача не найдена
- 500: Внутренняя ошибка сервера

---

## Уведомления

### GET /notifications

Получение списка уведомлений пользователя.

**Заголовки:**

- `Authorization: Bearer <jwt_token>`

**Успешный ответ (200):**

[
  {
    "id": 1,
    "message": "Создан проект: Проект 1",
    "is_read": false,
    "related_entity": "project",
    "related_entity_id": 1,
    "created_at": "2025-07-10T14:26:00"
  }
]

**Ошибки:**

- 401: Токен недействителен

---

## Общие ошибки

- 400: Неверные данные в запросе
- 401: Требуется авторизация или токен недействителен
- 403: Недостаточно прав
- 404: Ресурс не найден
- 500: Внутренняя ошибка сервера
  